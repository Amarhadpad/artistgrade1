<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Orders | Admin Panel - ArtistGrade</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../../../public/css/adminstyles.css">
</head>
<body>
<!-- Mobile Top Nav -->
<nav class="navbar navbar-light topnav d-md-none">
  <div class="container-fluid">
    <a class="navbar-brand brand" href="dashboard">AdminPanel</a>
    <div class="d-flex gap-2">
      <a class="btn btn-sm btn-outline-secondary" href="dashboard">Dashboard</a>
      <a class="btn btn-sm btn-outline-secondary" href="products">Products</a>
      <a class="btn btn-sm btn-outline-secondary" href="users">Users</a>
      <a class="btn btn-sm btn-outline-danger" href="#">Logout</a>
    </div>
  </div>
</nav>
<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <nav class="col-md-2 d-none d-md-block sidebar">
      <div class="text-center text-white mb-4 fw-bold fs-4">AdminPanel</div>
      <a href="dashboard"><i class="fas fa-chart-line me-2"></i> Dashboard</a>
      <a href="products"><i class="fas fa-box me-2"></i> Products</a>
      <a href="orders" class="active"><i class="fas fa-shopping-cart me-2"></i> Orders</a>
      <a href="users"><i class="fas fa-users me-2"></i> Users</a>
      <a href="#"><i class="fas fa-sign-out-alt me-2"></i> Logout</a>
      
    </nav>

    <!-- Main Content -->
    <main class="col-md-10 ms-sm-auto px-md-4">
      <div class="dashboard-header mt-4 mb-4">
        <h3 class="fw-semibold">Order Management</h3>
        <p class="text-muted">Track and manage customer orders</p>
      </div>

      <div class="card p-4">
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Customer</th>
                <th>Date</th>
                <th>Amount</th>
                <th>Status</th>
                <th>Items</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="ordersBody">
              <!-- Orders will be loaded here dynamically -->
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- Bootstrap Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Admin Orders JS -->
<script>
const ordersBody = document.getElementById("ordersBody");

async function loadOrders() {
  try {
    const res = await fetch('http://localhost:3000/api/orders'); // match your backend port
    if(!res.ok) throw new Error('Failed to fetch orders');

    const orders = await res.json();
    ordersBody.innerHTML = '';

    if(orders.length === 0) {
      ordersBody.innerHTML = `<tr><td colspan="6" class="text-center">No orders found</td></tr>`;
      return;
    }

    orders.forEach((order, index) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${order.orderId}</td>
        <td>
          ${order.fullName} <br>
          <small>${order.email}</small> <br>
          <small>${order.phone}</small>
        </td>
        <td>${new Date(order.date).toLocaleString()}</td>
        <td>₹${order.totalAmount.toFixed(2)}</td>
        <td>${order.status}</td>
        <td>
          <button class="btn btn-sm btn-primary" onclick="viewOrder('${order._id}')"><i class="fa-solid fa-eye"></i> View</button>
          <button class="btn btn-sm btn-danger" onclick="deleteOrder('${order._id}')"><i class="fa-solid fa-trash"></i></button>
        </td>
      `;
      ordersBody.appendChild(tr);
    });
  } catch(err) {
    console.error(err);
    ordersBody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Error loading orders</td></tr>`;
  }
}

async function viewOrder(id){
  try {
    const res = await fetch(`http://localhost:3000/api/orders/${id}`);
    if(!res.ok) throw new Error('Failed to fetch order');
    const order = await res.json();

    alert(`Order ID: ${order.orderId}\nCustomer: ${order.fullName}\nEmail: ${order.email}\nPhone: ${order.phone}\nAddress: ${order.address}, ${order.city}, ${order.state} - ${order.zip}\nTransaction ID: ${order.transactionId}\nItems:\n${order.cartItems.map(i => `${i.name} x${i.quantity} - ₹${i.price}`).join('\n')}\nTotal: ₹${order.totalAmount}\nStatus: ${order.status}`);
  } catch(err){
    console.error(err);
    alert("Failed to load order details");
  }
}

async function deleteOrder(id){
  if(!confirm("Are you sure you want to delete this order?")) return;
  try {
    const res = await fetch(`http://localhost:3000/api/orders/${id}`, { method: 'DELETE' });
    if(!res.ok) throw new Error('Failed to delete order');
    loadOrders();
  } catch(err){
    console.error(err);
    alert("Failed to delete order");
  }
}

document.addEventListener('DOMContentLoaded', loadOrders);
</script>

</body>
</html>