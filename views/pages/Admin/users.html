<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Users - ArtistGrade Admin Panel</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../../../public/css/adminstyles.css">
</head>
<body>
<nav class="navbar navbar-light topnav d-md-none">
  <div class="container-fluid">
    <a class="navbar-brand brand" href="dashboard.html">AdminPanel</a>
    <div class="d-flex gap-2">
      <a class="btn btn-sm btn-outline-secondary" href="dashboard">Dashboard</a>
      <a class="btn btn-sm btn-outline-secondary" href="products">Products</a>
      <a class="btn btn-sm btn-outline-secondary" href="orders">Orders</a>
      <a class="btn btn-sm btn-outline-danger" href="#">Logout</a>
    </div>
  </div>
</nav>

<div class="container-fluid">
  <div class="row">
    
    <nav class="col-md-2 d-none d-md-block sidebar">
      <div class="text-center text-white mb-4 fw-bold fs-4">AdminPanel</div>
      <a href="dashboard"><i class="fas fa-chart-line me-2"></i> Dashboard</a>
      <a href="products"><i class="fas fa-box me-2"></i> Products</a>
      <a href="orders"><i class="fas fa-shopping-cart me-2"></i> Orders</a>
      <a href="users" class="active"><i class="fas fa-users me-2"></i> Users</a>
      <a href="#"><i class="fas fa-sign-out-alt me-2"></i> Logout</a>
    </nav>

    <main class="col-md-10 ms-sm-auto px-md-4">
      <div class="dashboard-header mt-4 mb-4 d-flex justify-content-between align-items-center">
        <div>
          <h3 class="fw-semibold">Users</h3>
          <p class="text-muted">Manage registered users on ArtistGrade</p>
        </div>
        <div class="d-flex gap-2">
          <input type="text" id="searchInput" class="form-control" placeholder="Search users...">
          <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addUserModal">
            <i class="fas fa-plus me-1"></i> Add User
          </button>
        </div>
      </div>

      <div class="card p-4">
        <div class="table-responsive">
          <table class="table table-bordered table-hover table-striped align-middle">
            <thead class="table-dark">
              <tr>
                <th>User ID</th>
                <th>Name</th>
                <th>Email</th>
                <th>Joined</th>
                <th>Role</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="userTableBody">
              <!-- Users will be injected here -->
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>
</div>
<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="addUserForm">
        <div class="modal-header">
          <h5 class="modal-title" id="addUserModalLabel">Add New User</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <!-- Full Name -->
          <div class="mb-3">
            <label for="fullname" class="form-label">Full Name</label>
            <input type="text" id="fullname" name="fullname" class="form-control" placeholder="Enter full name" required>
          </div>

          <!-- Email -->
          <div class="mb-3">
            <label for="email" class="form-label">Email</label>
            <input type="email" id="email" name="email" class="form-control" placeholder="Enter email" required>
          </div>

          <!-- Username -->
          <div class="mb-3">
            <label for="username" class="form-label">Username</label>
            <input type="text" id="username" name="username" class="form-control" placeholder="Enter username" required>
          </div>

          <!-- Password -->
          <div class="mb-3">
            <label for="password" class="form-label">Password</label>
            <input type="password" id="password" name="password" class="form-control" placeholder="Enter password" required>
          </div>

          <!-- Confirm Password -->
          <div class="mb-3">
            <label for="confirmPassword" class="form-label">Confirm Password</label>
            <input type="password" id="confirmPassword" name="confirmPassword" class="form-control" placeholder="Confirm password" required>
          </div>

          <!-- Role -->
          <div class="mb-3">
            <label for="role" class="form-label">Role</label>
            <select id="role" name="role" class="form-select" required>
              <option value="User">User</option>
              <option value="Admin">Admin</option>
            </select>
          </div>
        </div>

        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Add User</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>
<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="editUserForm">
        <div class="modal-header">
          <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <input type="hidden" id="editUserId" name="id">
          <div class="mb-3">
            <label for="editFullname" class="form-label">Full Name</label>
            <input type="text" id="editFullname" name="fullname" class="form-control" required>
          </div>

          <div class="mb-3">
            <label for="editEmail" class="form-label">Email</label>
            <input type="email" id="editEmail" name="email" class="form-control" required>
          </div>

          <div class="mb-3">
            <label for="editUsername" class="form-label">Username</label>
            <input type="text" id="editUsername" name="username" class="form-control" required>
          </div>

          <div class="mb-3">
            <label for="editRole" class="form-label">Role</label>
            <select id="editRole" name="role" class="form-select" required>
              <option value="User">User</option>
              <option value="Admin">Admin</option>
            </select>
          </div>

          <div class="mb-3">
            <label for="editStatus" class="form-label">Status</label>
            <select id="editStatus" name="isActive" class="form-select">
              <option value="true">Active</option>
              <option value="false">Inactive</option>
            </select>
          </div>
        </div>

        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Save Changes</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>

const tableBody = document.getElementById('userTableBody');
const searchInput = document.getElementById('searchInput');

// Fetch and render users
async function fetchUsers() {
  try {
    const res = await fetch('/api/users');
    const users = await res.json();

    if(users.length === 0){
      tableBody.innerHTML = `<tr><td colspan="7" class="text-center">No users found</td></tr>`;
      return;
    }

    renderTable(users);

    // Search filter
    searchInput.addEventListener('input', () => {
      const query = searchInput.value.toLowerCase();
      const filtered = users.filter(u => 
        u.fullname.toLowerCase().includes(query) || 
        u.email.toLowerCase().includes(query)
      );
      renderTable(filtered);
    });

  } catch (err) {
    console.error(err);
    tableBody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">Failed to load users</td></tr>`;
  }
}

function renderTable(users) {
  tableBody.innerHTML = users.map(user => `
    <tr>
      <td>${user._id}</td>
      <td>${user.fullname}</td>
      <td>${user.email}</td>
      <td>${new Date(user.createdAt).toLocaleDateString()}</td>
      <td>${user.role || 'User'}</td>
      <td>${user.isActive ? 'Active' : 'Inactive'}</td>
      <td>
        <button class="btn btn-sm btn-warning" onclick="editUser('${user._id}')">Edit</button>
        <button class="btn btn-sm btn-danger" onclick="deleteUser('${user._id}')">Delete</button>
      </td>
    </tr>
  `).join('');
}

function editUser(id) {
  alert(`Edit user ${id} (implement later)`);
}

async function deleteUser(id) {
  if(!confirm('Are you sure you want to delete this user?')) return;
  try {
    const res = await fetch(`/api/users/${id}`, { method: 'DELETE' });
    const result = await res.json();
    alert(result.message);
    fetchUsers();
  } catch (err) {
    alert('Failed to delete user');
    console.error(err);
  }
}

// Add new user
document.getElementById('addUserForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const data = Object.fromEntries(formData.entries());

  try {
    const res = await fetch('/api/register', {  // Reuse your registration endpoint
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    const result = await res.json();
    alert(result.message);
    if(res.ok) {
      fetchUsers();
      e.target.reset();
      const modal = bootstrap.Modal.getInstance(document.getElementById('addUserModal'));
      modal.hide();
    }
  } catch (err) {
    alert('Failed to add user');
    console.error(err);
  }
});
function editUser(id) {
  const user = tableData.find(u => u._id === id); // use cached table data
  if(!user) return alert('User not found');

  // Fill modal with user data
  document.getElementById('editUserId').value = user._id;
  document.getElementById('editFullname').value = user.fullname;
  document.getElementById('editEmail').value = user.email;
  document.getElementById('editUsername').value = user.username;
  document.getElementById('editRole').value = user.role || 'User';
  document.getElementById('editStatus').value = user.isActive ? 'true' : 'false';

  // Show modal
  const editModal = new bootstrap.Modal(document.getElementById('editUserModal'));
  editModal.show();
}


// Initial load
fetchUsers();
</script>
</body>
</html>
